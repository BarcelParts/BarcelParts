{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.isResumableError = exports.isNetworkTimeoutError = exports.isSDAMUnrecoverableError = exports.isNodeShuttingDownError = exports.isRetryableReadError = exports.needsRetryableWriteLabel = exports.MongoWriteConcernError = exports.MongoServerSelectionError = exports.MongoSystemError = exports.MongoMissingDependencyError = exports.MongoMissingCredentialsError = exports.MongoCompatibilityError = exports.MongoInvalidArgumentError = exports.MongoParseError = exports.MongoNetworkTimeoutError = exports.MongoNetworkError = exports.isNetworkErrorBeforeHandshake = exports.MongoTopologyClosedError = exports.MongoCursorExhaustedError = exports.MongoServerClosedError = exports.MongoCursorInUseError = exports.MongoUnexpectedServerResponseError = exports.MongoGridFSChunkError = exports.MongoGridFSStreamError = exports.MongoTailableCursorError = exports.MongoChangeStreamError = exports.MongoKerberosError = exports.MongoExpiredSessionError = exports.MongoTransactionError = exports.MongoNotConnectedError = exports.MongoDecompressionError = exports.MongoBatchReExecutionError = exports.MongoRuntimeError = exports.MongoAPIError = exports.MongoDriverError = exports.MongoServerError = exports.MongoError = exports.MongoErrorLabel = exports.GET_MORE_RESUMABLE_CODES = exports.MONGODB_ERROR_CODES = exports.NODE_IS_RECOVERING_ERROR_MESSAGE = exports.LEGACY_NOT_PRIMARY_OR_SECONDARY_ERROR_MESSAGE = exports.LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE = void 0;\n/** @internal */\n\nconst kErrorLabels = Symbol('errorLabels');\n/**\r\n * @internal\r\n * The legacy error message from the server that indicates the node is not a writable primary\r\n * https://github.com/mongodb/specifications/blob/b07c26dc40d04ac20349f989db531c9845fdd755/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-writable-primary-and-node-is-recovering\r\n */\n\nexports.LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE = new RegExp('not master', 'i');\n/**\r\n * @internal\r\n * The legacy error message from the server that indicates the node is not a primary or secondary\r\n * https://github.com/mongodb/specifications/blob/b07c26dc40d04ac20349f989db531c9845fdd755/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-writable-primary-and-node-is-recovering\r\n */\n\nexports.LEGACY_NOT_PRIMARY_OR_SECONDARY_ERROR_MESSAGE = new RegExp('not master or secondary', 'i');\n/**\r\n * @internal\r\n * The error message from the server that indicates the node is recovering\r\n * https://github.com/mongodb/specifications/blob/b07c26dc40d04ac20349f989db531c9845fdd755/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-writable-primary-and-node-is-recovering\r\n */\n\nexports.NODE_IS_RECOVERING_ERROR_MESSAGE = new RegExp('node is recovering', 'i');\n/** @internal MongoDB Error Codes */\n\nexports.MONGODB_ERROR_CODES = Object.freeze({\n  HostUnreachable: 6,\n  HostNotFound: 7,\n  NetworkTimeout: 89,\n  ShutdownInProgress: 91,\n  PrimarySteppedDown: 189,\n  ExceededTimeLimit: 262,\n  SocketException: 9001,\n  NotWritablePrimary: 10107,\n  InterruptedAtShutdown: 11600,\n  InterruptedDueToReplStateChange: 11602,\n  NotPrimaryNoSecondaryOk: 13435,\n  NotPrimaryOrSecondary: 13436,\n  StaleShardVersion: 63,\n  StaleEpoch: 150,\n  StaleConfig: 13388,\n  RetryChangeStream: 234,\n  FailedToSatisfyReadPreference: 133,\n  CursorNotFound: 43,\n  LegacyNotPrimary: 10058,\n  WriteConcernFailed: 64,\n  NamespaceNotFound: 26,\n  IllegalOperation: 20,\n  MaxTimeMSExpired: 50,\n  UnknownReplWriteConcern: 79,\n  UnsatisfiableWriteConcern: 100\n}); // From spec@https://github.com/mongodb/specifications/blob/f93d78191f3db2898a59013a7ed5650352ef6da8/source/change-streams/change-streams.rst#resumable-error\n\nexports.GET_MORE_RESUMABLE_CODES = new Set([exports.MONGODB_ERROR_CODES.HostUnreachable, exports.MONGODB_ERROR_CODES.HostNotFound, exports.MONGODB_ERROR_CODES.NetworkTimeout, exports.MONGODB_ERROR_CODES.ShutdownInProgress, exports.MONGODB_ERROR_CODES.PrimarySteppedDown, exports.MONGODB_ERROR_CODES.ExceededTimeLimit, exports.MONGODB_ERROR_CODES.SocketException, exports.MONGODB_ERROR_CODES.NotWritablePrimary, exports.MONGODB_ERROR_CODES.InterruptedAtShutdown, exports.MONGODB_ERROR_CODES.InterruptedDueToReplStateChange, exports.MONGODB_ERROR_CODES.NotPrimaryNoSecondaryOk, exports.MONGODB_ERROR_CODES.NotPrimaryOrSecondary, exports.MONGODB_ERROR_CODES.StaleShardVersion, exports.MONGODB_ERROR_CODES.StaleEpoch, exports.MONGODB_ERROR_CODES.StaleConfig, exports.MONGODB_ERROR_CODES.RetryChangeStream, exports.MONGODB_ERROR_CODES.FailedToSatisfyReadPreference, exports.MONGODB_ERROR_CODES.CursorNotFound]);\n/** @public */\n\nexports.MongoErrorLabel = Object.freeze({\n  RetryableWriteError: 'RetryableWriteError',\n  TransientTransactionError: 'TransientTransactionError',\n  UnknownTransactionCommitResult: 'UnknownTransactionCommitResult',\n  ResumableChangeStreamError: 'ResumableChangeStreamError'\n});\n/**\r\n * @public\r\n * @category Error\r\n *\r\n * @privateRemarks\r\n * CSFLE has a dependency on this error, it uses the constructor with a string argument\r\n */\n\nclass MongoError extends Error {\n  constructor(message) {\n    if (message instanceof Error) {\n      super(message.message);\n    } else {\n      super(message);\n    }\n\n    this[kErrorLabels] = new Set();\n  }\n\n  get name() {\n    return 'MongoError';\n  }\n  /** Legacy name for server error responses */\n\n\n  get errmsg() {\n    return this.message;\n  }\n  /**\r\n   * Checks the error to see if it has an error label\r\n   *\r\n   * @param label - The error label to check for\r\n   * @returns returns true if the error has the provided error label\r\n   */\n\n\n  hasErrorLabel(label) {\n    return this[kErrorLabels].has(label);\n  }\n\n  addErrorLabel(label) {\n    this[kErrorLabels].add(label);\n  }\n\n  get errorLabels() {\n    return Array.from(this[kErrorLabels]);\n  }\n\n}\n\nexports.MongoError = MongoError;\n/**\r\n * An error coming from the mongo server\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoServerError extends MongoError {\n  constructor(message) {\n    super(message.message || message.errmsg || message.$err || 'n/a');\n\n    if (message.errorLabels) {\n      this[kErrorLabels] = new Set(message.errorLabels);\n    }\n\n    for (const name in message) {\n      if (name !== 'errorLabels' && name !== 'errmsg' && name !== 'message') this[name] = message[name];\n    }\n  }\n\n  get name() {\n    return 'MongoServerError';\n  }\n\n}\n\nexports.MongoServerError = MongoServerError;\n/**\r\n * An error generated by the driver\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoDriverError extends MongoError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoDriverError';\n  }\n\n}\n\nexports.MongoDriverError = MongoDriverError;\n/**\r\n * An error generated when the driver API is used incorrectly\r\n *\r\n * @privateRemarks\r\n * Should **never** be directly instantiated\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoAPIError extends MongoDriverError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoAPIError';\n  }\n\n}\n\nexports.MongoAPIError = MongoAPIError;\n/**\r\n * An error generated when the driver encounters unexpected input\r\n * or reaches an unexpected/invalid internal state\r\n *\r\n * @privateRemarks\r\n * Should **never** be directly instantiated.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoRuntimeError extends MongoDriverError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoRuntimeError';\n  }\n\n}\n\nexports.MongoRuntimeError = MongoRuntimeError;\n/**\r\n * An error generated when a batch command is re-executed after one of the commands in the batch\r\n * has failed\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoBatchReExecutionError extends MongoAPIError {\n  constructor() {\n    let message = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'This batch has already been executed, create new batch to execute';\n    super(message);\n  }\n\n  get name() {\n    return 'MongoBatchReExecutionError';\n  }\n\n}\n\nexports.MongoBatchReExecutionError = MongoBatchReExecutionError;\n/**\r\n * An error generated when the driver fails to decompress\r\n * data received from the server.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoDecompressionError extends MongoRuntimeError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoDecompressionError';\n  }\n\n}\n\nexports.MongoDecompressionError = MongoDecompressionError;\n/**\r\n * An error thrown when the user attempts to operate on a database or collection through a MongoClient\r\n * that has not yet successfully called the \"connect\" method\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoNotConnectedError extends MongoAPIError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoNotConnectedError';\n  }\n\n}\n\nexports.MongoNotConnectedError = MongoNotConnectedError;\n/**\r\n * An error generated when the user makes a mistake in the usage of transactions.\r\n * (e.g. attempting to commit a transaction with a readPreference other than primary)\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoTransactionError extends MongoAPIError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoTransactionError';\n  }\n\n}\n\nexports.MongoTransactionError = MongoTransactionError;\n/**\r\n * An error generated when the user attempts to operate\r\n * on a session that has expired or has been closed.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoExpiredSessionError extends MongoAPIError {\n  constructor() {\n    let message = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'Cannot use a session that has ended';\n    super(message);\n  }\n\n  get name() {\n    return 'MongoExpiredSessionError';\n  }\n\n}\n\nexports.MongoExpiredSessionError = MongoExpiredSessionError;\n/**\r\n * A error generated when the user attempts to authenticate\r\n * via Kerberos, but fails to connect to the Kerberos client.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoKerberosError extends MongoRuntimeError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoKerberosError';\n  }\n\n}\n\nexports.MongoKerberosError = MongoKerberosError;\n/**\r\n * An error generated when a ChangeStream operation fails to execute.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoChangeStreamError extends MongoRuntimeError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoChangeStreamError';\n  }\n\n}\n\nexports.MongoChangeStreamError = MongoChangeStreamError;\n/**\r\n * An error thrown when the user calls a function or method not supported on a tailable cursor\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoTailableCursorError extends MongoAPIError {\n  constructor() {\n    let message = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'Tailable cursor does not support this operation';\n    super(message);\n  }\n\n  get name() {\n    return 'MongoTailableCursorError';\n  }\n\n}\n\nexports.MongoTailableCursorError = MongoTailableCursorError;\n/** An error generated when a GridFSStream operation fails to execute.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoGridFSStreamError extends MongoRuntimeError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoGridFSStreamError';\n  }\n\n}\n\nexports.MongoGridFSStreamError = MongoGridFSStreamError;\n/**\r\n * An error generated when a malformed or invalid chunk is\r\n * encountered when reading from a GridFSStream.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoGridFSChunkError extends MongoRuntimeError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoGridFSChunkError';\n  }\n\n}\n\nexports.MongoGridFSChunkError = MongoGridFSChunkError;\n/**\r\n * An error generated when a **parsable** unexpected response comes from the server.\r\n * This is generally an error where the driver in a state expecting a certain behavior to occur in\r\n * the next message from MongoDB but it receives something else.\r\n * This error **does not** represent an issue with wire message formatting.\r\n *\r\n * #### Example\r\n * When an operation fails, it is the driver's job to retry it. It must perform serverSelection\r\n * again to make sure that it attempts the operation against a server in a good state. If server\r\n * selection returns a server that does not support retryable operations, this error is used.\r\n * This scenario is unlikely as retryable support would also have been determined on the first attempt\r\n * but it is possible the state change could report a selectable server that does not support retries.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoUnexpectedServerResponseError extends MongoRuntimeError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoUnexpectedServerResponseError';\n  }\n\n}\n\nexports.MongoUnexpectedServerResponseError = MongoUnexpectedServerResponseError;\n/**\r\n * An error thrown when the user attempts to add options to a cursor that has already been\r\n * initialized\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoCursorInUseError extends MongoAPIError {\n  constructor() {\n    let message = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'Cursor is already initialized';\n    super(message);\n  }\n\n  get name() {\n    return 'MongoCursorInUseError';\n  }\n\n}\n\nexports.MongoCursorInUseError = MongoCursorInUseError;\n/**\r\n * An error generated when an attempt is made to operate\r\n * on a closed/closing server.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoServerClosedError extends MongoAPIError {\n  constructor() {\n    let message = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'Server is closed';\n    super(message);\n  }\n\n  get name() {\n    return 'MongoServerClosedError';\n  }\n\n}\n\nexports.MongoServerClosedError = MongoServerClosedError;\n/**\r\n * An error thrown when an attempt is made to read from a cursor that has been exhausted\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoCursorExhaustedError extends MongoAPIError {\n  constructor(message) {\n    super(message || 'Cursor is exhausted');\n  }\n\n  get name() {\n    return 'MongoCursorExhaustedError';\n  }\n\n}\n\nexports.MongoCursorExhaustedError = MongoCursorExhaustedError;\n/**\r\n * An error generated when an attempt is made to operate on a\r\n * dropped, or otherwise unavailable, database.\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoTopologyClosedError extends MongoAPIError {\n  constructor() {\n    let message = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'Topology is closed';\n    super(message);\n  }\n\n  get name() {\n    return 'MongoTopologyClosedError';\n  }\n\n}\n\nexports.MongoTopologyClosedError = MongoTopologyClosedError;\n/** @internal */\n\nconst kBeforeHandshake = Symbol('beforeHandshake');\n\nfunction isNetworkErrorBeforeHandshake(err) {\n  return err[kBeforeHandshake] === true;\n}\n\nexports.isNetworkErrorBeforeHandshake = isNetworkErrorBeforeHandshake;\n/**\r\n * An error indicating an issue with the network, including TCP errors and timeouts.\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoNetworkError extends MongoError {\n  constructor(message, options) {\n    super(message);\n\n    if (options && typeof options.beforeHandshake === 'boolean') {\n      this[kBeforeHandshake] = options.beforeHandshake;\n    }\n  }\n\n  get name() {\n    return 'MongoNetworkError';\n  }\n\n}\n\nexports.MongoNetworkError = MongoNetworkError;\n/**\r\n * An error indicating a network timeout occurred\r\n * @public\r\n * @category Error\r\n *\r\n * @privateRemarks\r\n * CSFLE has a dependency on this error with an instanceof check\r\n */\n\nclass MongoNetworkTimeoutError extends MongoNetworkError {\n  constructor(message, options) {\n    super(message, options);\n  }\n\n  get name() {\n    return 'MongoNetworkTimeoutError';\n  }\n\n}\n\nexports.MongoNetworkTimeoutError = MongoNetworkTimeoutError;\n/**\r\n * An error used when attempting to parse a value (like a connection string)\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoParseError extends MongoDriverError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoParseError';\n  }\n\n}\n\nexports.MongoParseError = MongoParseError;\n/**\r\n * An error generated when the user supplies malformed or unexpected arguments\r\n * or when a required argument or field is not provided.\r\n *\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoInvalidArgumentError extends MongoAPIError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoInvalidArgumentError';\n  }\n\n}\n\nexports.MongoInvalidArgumentError = MongoInvalidArgumentError;\n/**\r\n * An error generated when a feature that is not enabled or allowed for the current server\r\n * configuration is used\r\n *\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoCompatibilityError extends MongoAPIError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoCompatibilityError';\n  }\n\n}\n\nexports.MongoCompatibilityError = MongoCompatibilityError;\n/**\r\n * An error generated when the user fails to provide authentication credentials before attempting\r\n * to connect to a mongo server instance.\r\n *\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoMissingCredentialsError extends MongoAPIError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoMissingCredentialsError';\n  }\n\n}\n\nexports.MongoMissingCredentialsError = MongoMissingCredentialsError;\n/**\r\n * An error generated when a required module or dependency is not present in the local environment\r\n *\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoMissingDependencyError extends MongoAPIError {\n  constructor(message) {\n    super(message);\n  }\n\n  get name() {\n    return 'MongoMissingDependencyError';\n  }\n\n}\n\nexports.MongoMissingDependencyError = MongoMissingDependencyError;\n/**\r\n * An error signifying a general system issue\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoSystemError extends MongoError {\n  constructor(message, reason) {\n    var _a;\n\n    if (reason && reason.error) {\n      super(reason.error.message || reason.error);\n    } else {\n      super(message);\n    }\n\n    if (reason) {\n      this.reason = reason;\n    }\n\n    this.code = (_a = reason.error) === null || _a === void 0 ? void 0 : _a.code;\n  }\n\n  get name() {\n    return 'MongoSystemError';\n  }\n\n}\n\nexports.MongoSystemError = MongoSystemError;\n/**\r\n * An error signifying a client-side server selection error\r\n * @public\r\n * @category Error\r\n */\n\nclass MongoServerSelectionError extends MongoSystemError {\n  constructor(message, reason) {\n    super(message, reason);\n  }\n\n  get name() {\n    return 'MongoServerSelectionError';\n  }\n\n}\n\nexports.MongoServerSelectionError = MongoServerSelectionError;\n\nfunction makeWriteConcernResultObject(input) {\n  const output = Object.assign({}, input);\n\n  if (output.ok === 0) {\n    output.ok = 1;\n    delete output.errmsg;\n    delete output.code;\n    delete output.codeName;\n  }\n\n  return output;\n}\n/**\r\n * An error thrown when the server reports a writeConcernError\r\n * @public\r\n * @category Error\r\n */\n\n\nclass MongoWriteConcernError extends MongoServerError {\n  constructor(message, result) {\n    if (result && Array.isArray(result.errorLabels)) {\n      message.errorLabels = result.errorLabels;\n    }\n\n    super(message);\n    this.errInfo = message.errInfo;\n\n    if (result != null) {\n      this.result = makeWriteConcernResultObject(result);\n    }\n  }\n\n  get name() {\n    return 'MongoWriteConcernError';\n  }\n\n}\n\nexports.MongoWriteConcernError = MongoWriteConcernError; // https://github.com/mongodb/specifications/blob/master/source/retryable-reads/retryable-reads.rst#retryable-error\n\nconst RETRYABLE_READ_ERROR_CODES = new Set([exports.MONGODB_ERROR_CODES.HostUnreachable, exports.MONGODB_ERROR_CODES.HostNotFound, exports.MONGODB_ERROR_CODES.NetworkTimeout, exports.MONGODB_ERROR_CODES.ShutdownInProgress, exports.MONGODB_ERROR_CODES.PrimarySteppedDown, exports.MONGODB_ERROR_CODES.SocketException, exports.MONGODB_ERROR_CODES.NotWritablePrimary, exports.MONGODB_ERROR_CODES.InterruptedAtShutdown, exports.MONGODB_ERROR_CODES.InterruptedDueToReplStateChange, exports.MONGODB_ERROR_CODES.NotPrimaryNoSecondaryOk, exports.MONGODB_ERROR_CODES.NotPrimaryOrSecondary]); // see: https://github.com/mongodb/specifications/blob/master/source/retryable-writes/retryable-writes.rst#terms\n\nconst RETRYABLE_WRITE_ERROR_CODES = new Set([...RETRYABLE_READ_ERROR_CODES, exports.MONGODB_ERROR_CODES.ExceededTimeLimit]);\n\nfunction needsRetryableWriteLabel(error, maxWireVersion) {\n  var _a, _b, _c;\n\n  if (maxWireVersion >= 9) {\n    // 4.4+ servers attach their own retryable write error\n    return false;\n  } // pre-4.4 server, then the driver adds an error label for every valid case\n  // execute operation will only inspect the label, code/message logic is handled here\n\n\n  if (error instanceof MongoNetworkError) {\n    return true;\n  }\n\n  if (error instanceof MongoError && error.hasErrorLabel(exports.MongoErrorLabel.RetryableWriteError)) {\n    // Before 4.4 the error label can be one way of identifying retry\n    // so we can return true if we have the label, but fall back to code checking below\n    return true;\n  }\n\n  if (error instanceof MongoWriteConcernError) {\n    return RETRYABLE_WRITE_ERROR_CODES.has((_c = (_b = (_a = error.result) === null || _a === void 0 ? void 0 : _a.code) !== null && _b !== void 0 ? _b : error.code) !== null && _c !== void 0 ? _c : 0);\n  }\n\n  if (error instanceof MongoError && typeof error.code === 'number') {\n    return RETRYABLE_WRITE_ERROR_CODES.has(error.code);\n  }\n\n  const isNotWritablePrimaryError = exports.LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE.test(error.message);\n\n  if (isNotWritablePrimaryError) {\n    return true;\n  }\n\n  const isNodeIsRecoveringError = exports.NODE_IS_RECOVERING_ERROR_MESSAGE.test(error.message);\n\n  if (isNodeIsRecoveringError) {\n    return true;\n  }\n\n  return false;\n}\n\nexports.needsRetryableWriteLabel = needsRetryableWriteLabel;\n/** Determines whether an error is something the driver should attempt to retry */\n\nfunction isRetryableReadError(error) {\n  const hasRetryableErrorCode = typeof error.code === 'number' ? RETRYABLE_READ_ERROR_CODES.has(error.code) : false;\n\n  if (hasRetryableErrorCode) {\n    return true;\n  }\n\n  if (error instanceof MongoNetworkError) {\n    return true;\n  }\n\n  const isNotWritablePrimaryError = exports.LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE.test(error.message);\n\n  if (isNotWritablePrimaryError) {\n    return true;\n  }\n\n  const isNodeIsRecoveringError = exports.NODE_IS_RECOVERING_ERROR_MESSAGE.test(error.message);\n\n  if (isNodeIsRecoveringError) {\n    return true;\n  }\n\n  return false;\n}\n\nexports.isRetryableReadError = isRetryableReadError;\nconst SDAM_RECOVERING_CODES = new Set([exports.MONGODB_ERROR_CODES.ShutdownInProgress, exports.MONGODB_ERROR_CODES.PrimarySteppedDown, exports.MONGODB_ERROR_CODES.InterruptedAtShutdown, exports.MONGODB_ERROR_CODES.InterruptedDueToReplStateChange, exports.MONGODB_ERROR_CODES.NotPrimaryOrSecondary]);\nconst SDAM_NOT_PRIMARY_CODES = new Set([exports.MONGODB_ERROR_CODES.NotWritablePrimary, exports.MONGODB_ERROR_CODES.NotPrimaryNoSecondaryOk, exports.MONGODB_ERROR_CODES.LegacyNotPrimary]);\nconst SDAM_NODE_SHUTTING_DOWN_ERROR_CODES = new Set([exports.MONGODB_ERROR_CODES.InterruptedAtShutdown, exports.MONGODB_ERROR_CODES.ShutdownInProgress]);\n\nfunction isRecoveringError(err) {\n  if (typeof err.code === 'number') {\n    // If any error code exists, we ignore the error.message\n    return SDAM_RECOVERING_CODES.has(err.code);\n  }\n\n  return exports.LEGACY_NOT_PRIMARY_OR_SECONDARY_ERROR_MESSAGE.test(err.message) || exports.NODE_IS_RECOVERING_ERROR_MESSAGE.test(err.message);\n}\n\nfunction isNotWritablePrimaryError(err) {\n  if (typeof err.code === 'number') {\n    // If any error code exists, we ignore the error.message\n    return SDAM_NOT_PRIMARY_CODES.has(err.code);\n  }\n\n  if (isRecoveringError(err)) {\n    return false;\n  }\n\n  return exports.LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE.test(err.message);\n}\n\nfunction isNodeShuttingDownError(err) {\n  return !!(typeof err.code === 'number' && SDAM_NODE_SHUTTING_DOWN_ERROR_CODES.has(err.code));\n}\n\nexports.isNodeShuttingDownError = isNodeShuttingDownError;\n/**\r\n * Determines whether SDAM can recover from a given error. If it cannot\r\n * then the pool will be cleared, and server state will completely reset\r\n * locally.\r\n *\r\n * @see https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-master-and-node-is-recovering\r\n */\n\nfunction isSDAMUnrecoverableError(error) {\n  // NOTE: null check is here for a strictly pre-CMAP world, a timeout or\n  //       close event are considered unrecoverable\n  if (error instanceof MongoParseError || error == null) {\n    return true;\n  }\n\n  return isRecoveringError(error) || isNotWritablePrimaryError(error);\n}\n\nexports.isSDAMUnrecoverableError = isSDAMUnrecoverableError;\n\nfunction isNetworkTimeoutError(err) {\n  return !!(err instanceof MongoNetworkError && err.message.match(/timed out/));\n}\n\nexports.isNetworkTimeoutError = isNetworkTimeoutError; // From spec@https://github.com/mongodb/specifications/blob/7a2e93d85935ee4b1046a8d2ad3514c657dc74fa/source/change-streams/change-streams.rst#resumable-error:\n//\n// An error is considered resumable if it meets any of the following criteria:\n// - any error encountered which is not a server error (e.g. a timeout error or network error)\n// - any server error response from a getMore command excluding those containing the error label\n//   NonRetryableChangeStreamError and those containing the following error codes:\n//   - Interrupted: 11601\n//   - CappedPositionLost: 136\n//   - CursorKilled: 237\n//\n// An error on an aggregate command is not a resumable error. Only errors on a getMore command may be considered resumable errors.\n\nfunction isResumableError(error, wireVersion) {\n  if (error instanceof MongoNetworkError) {\n    return true;\n  }\n\n  if (wireVersion != null && wireVersion >= 9) {\n    // DRIVERS-1308: For 4.4 drivers running against 4.4 servers, drivers will add a special case to treat the CursorNotFound error code as resumable\n    if (error && error instanceof MongoError && error.code === exports.MONGODB_ERROR_CODES.CursorNotFound) {\n      return true;\n    }\n\n    return error instanceof MongoError && error.hasErrorLabel(exports.MongoErrorLabel.ResumableChangeStreamError);\n  }\n\n  if (error && typeof error.code === 'number') {\n    return exports.GET_MORE_RESUMABLE_CODES.has(error.code);\n  }\n\n  return false;\n}\n\nexports.isResumableError = isResumableError;","map":{"version":3,"mappings":"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","names":["kErrorLabels","Symbol","exports","RegExp","Object","freeze","HostUnreachable","HostNotFound","NetworkTimeout","ShutdownInProgress","PrimarySteppedDown","ExceededTimeLimit","SocketException","NotWritablePrimary","InterruptedAtShutdown","InterruptedDueToReplStateChange","NotPrimaryNoSecondaryOk","NotPrimaryOrSecondary","StaleShardVersion","StaleEpoch","StaleConfig","RetryChangeStream","FailedToSatisfyReadPreference","CursorNotFound","LegacyNotPrimary","WriteConcernFailed","NamespaceNotFound","IllegalOperation","MaxTimeMSExpired","UnknownReplWriteConcern","UnsatisfiableWriteConcern","Set","RetryableWriteError","TransientTransactionError","UnknownTransactionCommitResult","ResumableChangeStreamError","MongoError","Error","constructor","message","name","errmsg","hasErrorLabel","label","has","addErrorLabel","add","errorLabels","Array","from","MongoServerError","$err","MongoDriverError","MongoAPIError","MongoRuntimeError","MongoBatchReExecutionError","MongoDecompressionError","MongoNotConnectedError","MongoTransactionError","MongoExpiredSessionError","MongoKerberosError","MongoChangeStreamError","MongoTailableCursorError","MongoGridFSStreamError","MongoGridFSChunkError","MongoUnexpectedServerResponseError","MongoCursorInUseError","MongoServerClosedError","MongoCursorExhaustedError","MongoTopologyClosedError","kBeforeHandshake","isNetworkErrorBeforeHandshake","err","MongoNetworkError","options","beforeHandshake","MongoNetworkTimeoutError","MongoParseError","MongoInvalidArgumentError","MongoCompatibilityError","MongoMissingCredentialsError","MongoMissingDependencyError","MongoSystemError","reason","error","code","_a","MongoServerSelectionError","makeWriteConcernResultObject","input","output","assign","ok","codeName","MongoWriteConcernError","result","isArray","errInfo","RETRYABLE_READ_ERROR_CODES","RETRYABLE_WRITE_ERROR_CODES","needsRetryableWriteLabel","maxWireVersion","_b","_c","isNotWritablePrimaryError","test","isNodeIsRecoveringError","isRetryableReadError","hasRetryableErrorCode","SDAM_RECOVERING_CODES","SDAM_NOT_PRIMARY_CODES","SDAM_NODE_SHUTTING_DOWN_ERROR_CODES","isRecoveringError","isNodeShuttingDownError","isSDAMUnrecoverableError","isNetworkTimeoutError","match","isResumableError","wireVersion"],"sources":["D:\\Barcelparts\\node_modules\\mongodb\\src\\error.ts"],"sourcesContent":["import type { Document } from './bson';\r\nimport type { TopologyVersion } from './sdam/server_description';\r\nimport type { TopologyDescription } from './sdam/topology_description';\r\n\r\n/** @public */\r\nexport type AnyError = MongoError | Error;\r\n\r\n/** @internal */\r\nconst kErrorLabels = Symbol('errorLabels');\r\n\r\n/**\r\n * @internal\r\n * The legacy error message from the server that indicates the node is not a writable primary\r\n * https://github.com/mongodb/specifications/blob/b07c26dc40d04ac20349f989db531c9845fdd755/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-writable-primary-and-node-is-recovering\r\n */\r\nexport const LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE = new RegExp('not master', 'i');\r\n\r\n/**\r\n * @internal\r\n * The legacy error message from the server that indicates the node is not a primary or secondary\r\n * https://github.com/mongodb/specifications/blob/b07c26dc40d04ac20349f989db531c9845fdd755/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-writable-primary-and-node-is-recovering\r\n */\r\nexport const LEGACY_NOT_PRIMARY_OR_SECONDARY_ERROR_MESSAGE = new RegExp(\r\n  'not master or secondary',\r\n  'i'\r\n);\r\n\r\n/**\r\n * @internal\r\n * The error message from the server that indicates the node is recovering\r\n * https://github.com/mongodb/specifications/blob/b07c26dc40d04ac20349f989db531c9845fdd755/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-writable-primary-and-node-is-recovering\r\n */\r\nexport const NODE_IS_RECOVERING_ERROR_MESSAGE = new RegExp('node is recovering', 'i');\r\n\r\n/** @internal MongoDB Error Codes */\r\nexport const MONGODB_ERROR_CODES = Object.freeze({\r\n  HostUnreachable: 6,\r\n  HostNotFound: 7,\r\n  NetworkTimeout: 89,\r\n  ShutdownInProgress: 91,\r\n  PrimarySteppedDown: 189,\r\n  ExceededTimeLimit: 262,\r\n  SocketException: 9001,\r\n  NotWritablePrimary: 10107,\r\n  InterruptedAtShutdown: 11600,\r\n  InterruptedDueToReplStateChange: 11602,\r\n  NotPrimaryNoSecondaryOk: 13435,\r\n  NotPrimaryOrSecondary: 13436,\r\n  StaleShardVersion: 63,\r\n  StaleEpoch: 150,\r\n  StaleConfig: 13388,\r\n  RetryChangeStream: 234,\r\n  FailedToSatisfyReadPreference: 133,\r\n  CursorNotFound: 43,\r\n  LegacyNotPrimary: 10058,\r\n  WriteConcernFailed: 64,\r\n  NamespaceNotFound: 26,\r\n  IllegalOperation: 20,\r\n  MaxTimeMSExpired: 50,\r\n  UnknownReplWriteConcern: 79,\r\n  UnsatisfiableWriteConcern: 100\r\n} as const);\r\n\r\n// From spec@https://github.com/mongodb/specifications/blob/f93d78191f3db2898a59013a7ed5650352ef6da8/source/change-streams/change-streams.rst#resumable-error\r\nexport const GET_MORE_RESUMABLE_CODES = new Set<number>([\r\n  MONGODB_ERROR_CODES.HostUnreachable,\r\n  MONGODB_ERROR_CODES.HostNotFound,\r\n  MONGODB_ERROR_CODES.NetworkTimeout,\r\n  MONGODB_ERROR_CODES.ShutdownInProgress,\r\n  MONGODB_ERROR_CODES.PrimarySteppedDown,\r\n  MONGODB_ERROR_CODES.ExceededTimeLimit,\r\n  MONGODB_ERROR_CODES.SocketException,\r\n  MONGODB_ERROR_CODES.NotWritablePrimary,\r\n  MONGODB_ERROR_CODES.InterruptedAtShutdown,\r\n  MONGODB_ERROR_CODES.InterruptedDueToReplStateChange,\r\n  MONGODB_ERROR_CODES.NotPrimaryNoSecondaryOk,\r\n  MONGODB_ERROR_CODES.NotPrimaryOrSecondary,\r\n  MONGODB_ERROR_CODES.StaleShardVersion,\r\n  MONGODB_ERROR_CODES.StaleEpoch,\r\n  MONGODB_ERROR_CODES.StaleConfig,\r\n  MONGODB_ERROR_CODES.RetryChangeStream,\r\n  MONGODB_ERROR_CODES.FailedToSatisfyReadPreference,\r\n  MONGODB_ERROR_CODES.CursorNotFound\r\n]);\r\n\r\n/** @public */\r\nexport const MongoErrorLabel = Object.freeze({\r\n  RetryableWriteError: 'RetryableWriteError',\r\n  TransientTransactionError: 'TransientTransactionError',\r\n  UnknownTransactionCommitResult: 'UnknownTransactionCommitResult',\r\n  ResumableChangeStreamError: 'ResumableChangeStreamError'\r\n} as const);\r\n\r\n/** @public */\r\nexport type MongoErrorLabel = typeof MongoErrorLabel[keyof typeof MongoErrorLabel];\r\n\r\n/** @public */\r\nexport interface ErrorDescription extends Document {\r\n  message?: string;\r\n  errmsg?: string;\r\n  $err?: string;\r\n  errorLabels?: string[];\r\n  errInfo?: Document;\r\n}\r\n\r\n/**\r\n * @public\r\n * @category Error\r\n *\r\n * @privateRemarks\r\n * CSFLE has a dependency on this error, it uses the constructor with a string argument\r\n */\r\nexport class MongoError extends Error {\r\n  /** @internal */\r\n  [kErrorLabels]: Set<string>;\r\n  /**\r\n   * This is a number in MongoServerError and a string in MongoDriverError\r\n   * @privateRemarks\r\n   * Define the type override on the subclasses when we can use the override keyword\r\n   */\r\n  code?: number | string;\r\n  topologyVersion?: TopologyVersion;\r\n\r\n  constructor(message: string | Error) {\r\n    if (message instanceof Error) {\r\n      super(message.message);\r\n    } else {\r\n      super(message);\r\n    }\r\n    this[kErrorLabels] = new Set();\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoError';\r\n  }\r\n\r\n  /** Legacy name for server error responses */\r\n  get errmsg(): string {\r\n    return this.message;\r\n  }\r\n\r\n  /**\r\n   * Checks the error to see if it has an error label\r\n   *\r\n   * @param label - The error label to check for\r\n   * @returns returns true if the error has the provided error label\r\n   */\r\n  hasErrorLabel(label: string): boolean {\r\n    return this[kErrorLabels].has(label);\r\n  }\r\n\r\n  addErrorLabel(label: string): void {\r\n    this[kErrorLabels].add(label);\r\n  }\r\n\r\n  get errorLabels(): string[] {\r\n    return Array.from(this[kErrorLabels]);\r\n  }\r\n}\r\n\r\n/**\r\n * An error coming from the mongo server\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoServerError extends MongoError {\r\n  codeName?: string;\r\n  writeConcernError?: Document;\r\n  errInfo?: Document;\r\n  ok?: number;\r\n  [key: string]: any;\r\n\r\n  constructor(message: ErrorDescription) {\r\n    super(message.message || message.errmsg || message.$err || 'n/a');\r\n    if (message.errorLabels) {\r\n      this[kErrorLabels] = new Set(message.errorLabels);\r\n    }\r\n\r\n    for (const name in message) {\r\n      if (name !== 'errorLabels' && name !== 'errmsg' && name !== 'message')\r\n        this[name] = message[name];\r\n    }\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoServerError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated by the driver\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoDriverError extends MongoError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoDriverError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when the driver API is used incorrectly\r\n *\r\n * @privateRemarks\r\n * Should **never** be directly instantiated\r\n *\r\n * @public\r\n * @category Error\r\n */\r\n\r\nexport class MongoAPIError extends MongoDriverError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoAPIError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when the driver encounters unexpected input\r\n * or reaches an unexpected/invalid internal state\r\n *\r\n * @privateRemarks\r\n * Should **never** be directly instantiated.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoRuntimeError extends MongoDriverError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoRuntimeError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when a batch command is re-executed after one of the commands in the batch\r\n * has failed\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoBatchReExecutionError extends MongoAPIError {\r\n  constructor(message = 'This batch has already been executed, create new batch to execute') {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoBatchReExecutionError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when the driver fails to decompress\r\n * data received from the server.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoDecompressionError extends MongoRuntimeError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoDecompressionError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error thrown when the user attempts to operate on a database or collection through a MongoClient\r\n * that has not yet successfully called the \"connect\" method\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoNotConnectedError extends MongoAPIError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoNotConnectedError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when the user makes a mistake in the usage of transactions.\r\n * (e.g. attempting to commit a transaction with a readPreference other than primary)\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoTransactionError extends MongoAPIError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoTransactionError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when the user attempts to operate\r\n * on a session that has expired or has been closed.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoExpiredSessionError extends MongoAPIError {\r\n  constructor(message = 'Cannot use a session that has ended') {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoExpiredSessionError';\r\n  }\r\n}\r\n\r\n/**\r\n * A error generated when the user attempts to authenticate\r\n * via Kerberos, but fails to connect to the Kerberos client.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoKerberosError extends MongoRuntimeError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoKerberosError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when a ChangeStream operation fails to execute.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoChangeStreamError extends MongoRuntimeError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoChangeStreamError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error thrown when the user calls a function or method not supported on a tailable cursor\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoTailableCursorError extends MongoAPIError {\r\n  constructor(message = 'Tailable cursor does not support this operation') {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoTailableCursorError';\r\n  }\r\n}\r\n\r\n/** An error generated when a GridFSStream operation fails to execute.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoGridFSStreamError extends MongoRuntimeError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoGridFSStreamError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when a malformed or invalid chunk is\r\n * encountered when reading from a GridFSStream.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoGridFSChunkError extends MongoRuntimeError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoGridFSChunkError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when a **parsable** unexpected response comes from the server.\r\n * This is generally an error where the driver in a state expecting a certain behavior to occur in\r\n * the next message from MongoDB but it receives something else.\r\n * This error **does not** represent an issue with wire message formatting.\r\n *\r\n * #### Example\r\n * When an operation fails, it is the driver's job to retry it. It must perform serverSelection\r\n * again to make sure that it attempts the operation against a server in a good state. If server\r\n * selection returns a server that does not support retryable operations, this error is used.\r\n * This scenario is unlikely as retryable support would also have been determined on the first attempt\r\n * but it is possible the state change could report a selectable server that does not support retries.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoUnexpectedServerResponseError extends MongoRuntimeError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoUnexpectedServerResponseError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error thrown when the user attempts to add options to a cursor that has already been\r\n * initialized\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoCursorInUseError extends MongoAPIError {\r\n  constructor(message = 'Cursor is already initialized') {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoCursorInUseError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when an attempt is made to operate\r\n * on a closed/closing server.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoServerClosedError extends MongoAPIError {\r\n  constructor(message = 'Server is closed') {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoServerClosedError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error thrown when an attempt is made to read from a cursor that has been exhausted\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoCursorExhaustedError extends MongoAPIError {\r\n  constructor(message?: string) {\r\n    super(message || 'Cursor is exhausted');\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoCursorExhaustedError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when an attempt is made to operate on a\r\n * dropped, or otherwise unavailable, database.\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoTopologyClosedError extends MongoAPIError {\r\n  constructor(message = 'Topology is closed') {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoTopologyClosedError';\r\n  }\r\n}\r\n\r\n/** @internal */\r\nconst kBeforeHandshake = Symbol('beforeHandshake');\r\nexport function isNetworkErrorBeforeHandshake(err: MongoNetworkError): boolean {\r\n  return err[kBeforeHandshake] === true;\r\n}\r\n\r\n/** @public */\r\nexport interface MongoNetworkErrorOptions {\r\n  /** Indicates the timeout happened before a connection handshake completed */\r\n  beforeHandshake: boolean;\r\n}\r\n\r\n/**\r\n * An error indicating an issue with the network, including TCP errors and timeouts.\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoNetworkError extends MongoError {\r\n  /** @internal */\r\n  [kBeforeHandshake]?: boolean;\r\n\r\n  constructor(message: string | Error, options?: MongoNetworkErrorOptions) {\r\n    super(message);\r\n\r\n    if (options && typeof options.beforeHandshake === 'boolean') {\r\n      this[kBeforeHandshake] = options.beforeHandshake;\r\n    }\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoNetworkError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error indicating a network timeout occurred\r\n * @public\r\n * @category Error\r\n *\r\n * @privateRemarks\r\n * CSFLE has a dependency on this error with an instanceof check\r\n */\r\nexport class MongoNetworkTimeoutError extends MongoNetworkError {\r\n  constructor(message: string, options?: MongoNetworkErrorOptions) {\r\n    super(message, options);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoNetworkTimeoutError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error used when attempting to parse a value (like a connection string)\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoParseError extends MongoDriverError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoParseError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when the user supplies malformed or unexpected arguments\r\n * or when a required argument or field is not provided.\r\n *\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoInvalidArgumentError extends MongoAPIError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoInvalidArgumentError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when a feature that is not enabled or allowed for the current server\r\n * configuration is used\r\n *\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoCompatibilityError extends MongoAPIError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoCompatibilityError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when the user fails to provide authentication credentials before attempting\r\n * to connect to a mongo server instance.\r\n *\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoMissingCredentialsError extends MongoAPIError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoMissingCredentialsError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error generated when a required module or dependency is not present in the local environment\r\n *\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoMissingDependencyError extends MongoAPIError {\r\n  constructor(message: string) {\r\n    super(message);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoMissingDependencyError';\r\n  }\r\n}\r\n/**\r\n * An error signifying a general system issue\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoSystemError extends MongoError {\r\n  /** An optional reason context, such as an error saved during flow of monitoring and selecting servers */\r\n  reason?: TopologyDescription;\r\n\r\n  constructor(message: string, reason: TopologyDescription) {\r\n    if (reason && reason.error) {\r\n      super(reason.error.message || reason.error);\r\n    } else {\r\n      super(message);\r\n    }\r\n\r\n    if (reason) {\r\n      this.reason = reason;\r\n    }\r\n\r\n    this.code = reason.error?.code;\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoSystemError';\r\n  }\r\n}\r\n\r\n/**\r\n * An error signifying a client-side server selection error\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoServerSelectionError extends MongoSystemError {\r\n  constructor(message: string, reason: TopologyDescription) {\r\n    super(message, reason);\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoServerSelectionError';\r\n  }\r\n}\r\n\r\nfunction makeWriteConcernResultObject(input: any) {\r\n  const output = Object.assign({}, input);\r\n\r\n  if (output.ok === 0) {\r\n    output.ok = 1;\r\n    delete output.errmsg;\r\n    delete output.code;\r\n    delete output.codeName;\r\n  }\r\n\r\n  return output;\r\n}\r\n\r\n/**\r\n * An error thrown when the server reports a writeConcernError\r\n * @public\r\n * @category Error\r\n */\r\nexport class MongoWriteConcernError extends MongoServerError {\r\n  /** The result document (provided if ok: 1) */\r\n  result?: Document;\r\n\r\n  constructor(message: ErrorDescription, result?: Document) {\r\n    if (result && Array.isArray(result.errorLabels)) {\r\n      message.errorLabels = result.errorLabels;\r\n    }\r\n\r\n    super(message);\r\n    this.errInfo = message.errInfo;\r\n\r\n    if (result != null) {\r\n      this.result = makeWriteConcernResultObject(result);\r\n    }\r\n  }\r\n\r\n  override get name(): string {\r\n    return 'MongoWriteConcernError';\r\n  }\r\n}\r\n\r\n// https://github.com/mongodb/specifications/blob/master/source/retryable-reads/retryable-reads.rst#retryable-error\r\nconst RETRYABLE_READ_ERROR_CODES = new Set<number>([\r\n  MONGODB_ERROR_CODES.HostUnreachable,\r\n  MONGODB_ERROR_CODES.HostNotFound,\r\n  MONGODB_ERROR_CODES.NetworkTimeout,\r\n  MONGODB_ERROR_CODES.ShutdownInProgress,\r\n  MONGODB_ERROR_CODES.PrimarySteppedDown,\r\n  MONGODB_ERROR_CODES.SocketException,\r\n  MONGODB_ERROR_CODES.NotWritablePrimary,\r\n  MONGODB_ERROR_CODES.InterruptedAtShutdown,\r\n  MONGODB_ERROR_CODES.InterruptedDueToReplStateChange,\r\n  MONGODB_ERROR_CODES.NotPrimaryNoSecondaryOk,\r\n  MONGODB_ERROR_CODES.NotPrimaryOrSecondary\r\n]);\r\n\r\n// see: https://github.com/mongodb/specifications/blob/master/source/retryable-writes/retryable-writes.rst#terms\r\nconst RETRYABLE_WRITE_ERROR_CODES = new Set<number>([\r\n  ...RETRYABLE_READ_ERROR_CODES,\r\n  MONGODB_ERROR_CODES.ExceededTimeLimit\r\n]);\r\n\r\nexport function needsRetryableWriteLabel(error: Error, maxWireVersion: number): boolean {\r\n  if (maxWireVersion >= 9) {\r\n    // 4.4+ servers attach their own retryable write error\r\n    return false;\r\n  }\r\n  // pre-4.4 server, then the driver adds an error label for every valid case\r\n  // execute operation will only inspect the label, code/message logic is handled here\r\n\r\n  if (error instanceof MongoNetworkError) {\r\n    return true;\r\n  }\r\n\r\n  if (error instanceof MongoError && error.hasErrorLabel(MongoErrorLabel.RetryableWriteError)) {\r\n    // Before 4.4 the error label can be one way of identifying retry\r\n    // so we can return true if we have the label, but fall back to code checking below\r\n    return true;\r\n  }\r\n\r\n  if (error instanceof MongoWriteConcernError) {\r\n    return RETRYABLE_WRITE_ERROR_CODES.has(error.result?.code ?? error.code ?? 0);\r\n  }\r\n\r\n  if (error instanceof MongoError && typeof error.code === 'number') {\r\n    return RETRYABLE_WRITE_ERROR_CODES.has(error.code);\r\n  }\r\n\r\n  const isNotWritablePrimaryError = LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE.test(error.message);\r\n  if (isNotWritablePrimaryError) {\r\n    return true;\r\n  }\r\n\r\n  const isNodeIsRecoveringError = NODE_IS_RECOVERING_ERROR_MESSAGE.test(error.message);\r\n  if (isNodeIsRecoveringError) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/** Determines whether an error is something the driver should attempt to retry */\r\nexport function isRetryableReadError(error: MongoError): boolean {\r\n  const hasRetryableErrorCode =\r\n    typeof error.code === 'number' ? RETRYABLE_READ_ERROR_CODES.has(error.code) : false;\r\n  if (hasRetryableErrorCode) {\r\n    return true;\r\n  }\r\n\r\n  if (error instanceof MongoNetworkError) {\r\n    return true;\r\n  }\r\n\r\n  const isNotWritablePrimaryError = LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE.test(error.message);\r\n  if (isNotWritablePrimaryError) {\r\n    return true;\r\n  }\r\n\r\n  const isNodeIsRecoveringError = NODE_IS_RECOVERING_ERROR_MESSAGE.test(error.message);\r\n  if (isNodeIsRecoveringError) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nconst SDAM_RECOVERING_CODES = new Set<number>([\r\n  MONGODB_ERROR_CODES.ShutdownInProgress,\r\n  MONGODB_ERROR_CODES.PrimarySteppedDown,\r\n  MONGODB_ERROR_CODES.InterruptedAtShutdown,\r\n  MONGODB_ERROR_CODES.InterruptedDueToReplStateChange,\r\n  MONGODB_ERROR_CODES.NotPrimaryOrSecondary\r\n]);\r\n\r\nconst SDAM_NOT_PRIMARY_CODES = new Set<number>([\r\n  MONGODB_ERROR_CODES.NotWritablePrimary,\r\n  MONGODB_ERROR_CODES.NotPrimaryNoSecondaryOk,\r\n  MONGODB_ERROR_CODES.LegacyNotPrimary\r\n]);\r\n\r\nconst SDAM_NODE_SHUTTING_DOWN_ERROR_CODES = new Set<number>([\r\n  MONGODB_ERROR_CODES.InterruptedAtShutdown,\r\n  MONGODB_ERROR_CODES.ShutdownInProgress\r\n]);\r\n\r\nfunction isRecoveringError(err: MongoError) {\r\n  if (typeof err.code === 'number') {\r\n    // If any error code exists, we ignore the error.message\r\n    return SDAM_RECOVERING_CODES.has(err.code);\r\n  }\r\n\r\n  return (\r\n    LEGACY_NOT_PRIMARY_OR_SECONDARY_ERROR_MESSAGE.test(err.message) ||\r\n    NODE_IS_RECOVERING_ERROR_MESSAGE.test(err.message)\r\n  );\r\n}\r\n\r\nfunction isNotWritablePrimaryError(err: MongoError) {\r\n  if (typeof err.code === 'number') {\r\n    // If any error code exists, we ignore the error.message\r\n    return SDAM_NOT_PRIMARY_CODES.has(err.code);\r\n  }\r\n\r\n  if (isRecoveringError(err)) {\r\n    return false;\r\n  }\r\n\r\n  return LEGACY_NOT_WRITABLE_PRIMARY_ERROR_MESSAGE.test(err.message);\r\n}\r\n\r\nexport function isNodeShuttingDownError(err: MongoError): boolean {\r\n  return !!(typeof err.code === 'number' && SDAM_NODE_SHUTTING_DOWN_ERROR_CODES.has(err.code));\r\n}\r\n\r\n/**\r\n * Determines whether SDAM can recover from a given error. If it cannot\r\n * then the pool will be cleared, and server state will completely reset\r\n * locally.\r\n *\r\n * @see https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#not-master-and-node-is-recovering\r\n */\r\nexport function isSDAMUnrecoverableError(error: MongoError): boolean {\r\n  // NOTE: null check is here for a strictly pre-CMAP world, a timeout or\r\n  //       close event are considered unrecoverable\r\n  if (error instanceof MongoParseError || error == null) {\r\n    return true;\r\n  }\r\n\r\n  return isRecoveringError(error) || isNotWritablePrimaryError(error);\r\n}\r\n\r\nexport function isNetworkTimeoutError(err: MongoError): err is MongoNetworkError {\r\n  return !!(err instanceof MongoNetworkError && err.message.match(/timed out/));\r\n}\r\n\r\n// From spec@https://github.com/mongodb/specifications/blob/7a2e93d85935ee4b1046a8d2ad3514c657dc74fa/source/change-streams/change-streams.rst#resumable-error:\r\n//\r\n// An error is considered resumable if it meets any of the following criteria:\r\n// - any error encountered which is not a server error (e.g. a timeout error or network error)\r\n// - any server error response from a getMore command excluding those containing the error label\r\n//   NonRetryableChangeStreamError and those containing the following error codes:\r\n//   - Interrupted: 11601\r\n//   - CappedPositionLost: 136\r\n//   - CursorKilled: 237\r\n//\r\n// An error on an aggregate command is not a resumable error. Only errors on a getMore command may be considered resumable errors.\r\n\r\nexport function isResumableError(error?: MongoError, wireVersion?: number): boolean {\r\n  if (error instanceof MongoNetworkError) {\r\n    return true;\r\n  }\r\n\r\n  if (wireVersion != null && wireVersion >= 9) {\r\n    // DRIVERS-1308: For 4.4 drivers running against 4.4 servers, drivers will add a special case to treat the CursorNotFound error code as resumable\r\n    if (error && error instanceof MongoError && error.code === MONGODB_ERROR_CODES.CursorNotFound) {\r\n      return true;\r\n    }\r\n    return (\r\n      error instanceof MongoError && error.hasErrorLabel(MongoErrorLabel.ResumableChangeStreamError)\r\n    );\r\n  }\r\n\r\n  if (error && typeof error.code === 'number') {\r\n    return GET_MORE_RESUMABLE_CODES.has(error.code);\r\n  }\r\n  return false;\r\n}\r\n"]},"metadata":{},"sourceType":"script"}