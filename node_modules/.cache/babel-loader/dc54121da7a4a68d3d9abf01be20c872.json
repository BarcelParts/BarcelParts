{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Encrypter = void 0;\n/* eslint-disable @typescript-eslint/no-var-requires */\n\nconst bson_1 = require(\"./bson\");\n\nconst constants_1 = require(\"./constants\");\n\nconst error_1 = require(\"./error\");\n\nconst mongo_client_1 = require(\"./mongo_client\");\n\nlet AutoEncrypterClass;\n/** @internal */\n\nconst kInternalClient = Symbol('internalClient');\n/** @internal */\n\nclass Encrypter {\n  constructor(client, uri, options) {\n    if (typeof options.autoEncryption !== 'object') {\n      throw new error_1.MongoInvalidArgumentError('Option \"autoEncryption\" must be specified');\n    } // initialize to null, if we call getInternalClient, we may set this it is important to not overwrite those function calls.\n\n\n    this[kInternalClient] = null;\n    this.bypassAutoEncryption = !!options.autoEncryption.bypassAutoEncryption;\n    this.needsConnecting = false;\n\n    if (options.maxPoolSize === 0 && options.autoEncryption.keyVaultClient == null) {\n      options.autoEncryption.keyVaultClient = client;\n    } else if (options.autoEncryption.keyVaultClient == null) {\n      options.autoEncryption.keyVaultClient = this.getInternalClient(client, uri, options);\n    }\n\n    if (this.bypassAutoEncryption) {\n      options.autoEncryption.metadataClient = undefined;\n    } else if (options.maxPoolSize === 0) {\n      options.autoEncryption.metadataClient = client;\n    } else {\n      options.autoEncryption.metadataClient = this.getInternalClient(client, uri, options);\n    }\n\n    if (options.proxyHost) {\n      options.autoEncryption.proxyOptions = {\n        proxyHost: options.proxyHost,\n        proxyPort: options.proxyPort,\n        proxyUsername: options.proxyUsername,\n        proxyPassword: options.proxyPassword\n      };\n    }\n\n    options.autoEncryption.bson = Object.create(null); // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\n    options.autoEncryption.bson.serialize = bson_1.serialize; // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\n    options.autoEncryption.bson.deserialize = bson_1.deserialize;\n    this.autoEncrypter = new AutoEncrypterClass(client, options.autoEncryption);\n  }\n\n  getInternalClient(client, uri, options) {\n    // TODO(NODE-4144): Remove new variable for type narrowing\n    let internalClient = this[kInternalClient];\n\n    if (internalClient == null) {\n      const clonedOptions = {};\n\n      for (const key of Object.keys(options)) {\n        if (['autoEncryption', 'minPoolSize', 'servers', 'caseTranslate', 'dbName'].includes(key)) continue;\n        Reflect.set(clonedOptions, key, Reflect.get(options, key));\n      }\n\n      clonedOptions.minPoolSize = 0;\n      internalClient = new mongo_client_1.MongoClient(uri, clonedOptions);\n      this[kInternalClient] = internalClient;\n\n      for (const eventName of constants_1.MONGO_CLIENT_EVENTS) {\n        for (const listener of client.listeners(eventName)) {\n          internalClient.on(eventName, listener);\n        }\n      }\n\n      client.on('newListener', (eventName, listener) => {\n        internalClient === null || internalClient === void 0 ? void 0 : internalClient.on(eventName, listener);\n      });\n      this.needsConnecting = true;\n    }\n\n    return internalClient;\n  }\n\n  connectInternalClient(callback) {\n    // TODO(NODE-4144): Remove new variable for type narrowing\n    const internalClient = this[kInternalClient];\n\n    if (this.needsConnecting && internalClient != null) {\n      this.needsConnecting = false;\n      return internalClient.connect(callback);\n    }\n\n    return callback();\n  }\n\n  close(client, force, callback) {\n    this.autoEncrypter.teardown(!!force, e => {\n      const internalClient = this[kInternalClient];\n\n      if (internalClient != null && client !== internalClient) {\n        return internalClient.close(force, callback);\n      }\n\n      callback(e);\n    });\n  }\n\n  static checkForMongoCrypt() {\n    let mongodbClientEncryption = undefined;\n\n    try {\n      // Ensure you always wrap an optional require in the try block NODE-3199\n      mongodbClientEncryption = require('mongodb-client-encryption');\n    } catch (err) {\n      throw new error_1.MongoMissingDependencyError('Auto-encryption requested, but the module is not installed. ' + 'Please add `mongodb-client-encryption` as a dependency of your project');\n    }\n\n    AutoEncrypterClass = mongodbClientEncryption.extension(require('../lib/index')).AutoEncrypter;\n  }\n\n}\n\nexports.Encrypter = Encrypter;","map":{"version":3,"mappings":"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","names":["AutoEncrypterClass","kInternalClient","Symbol","Encrypter","constructor","client","uri","options","autoEncryption","error_1","bypassAutoEncryption","needsConnecting","maxPoolSize","keyVaultClient","getInternalClient","metadataClient","undefined","proxyHost","proxyOptions","proxyPort","proxyUsername","proxyPassword","bson","Object","create","serialize","bson_1","deserialize","autoEncrypter","internalClient","clonedOptions","key","keys","includes","Reflect","set","get","minPoolSize","mongo_client_1","eventName","constants_1","listener","listeners","on","connectInternalClient","callback","connect","close","force","teardown","e","checkForMongoCrypt","mongodbClientEncryption","require","err","extension","AutoEncrypter","exports"],"sources":["D:\\Barcelparts\\node_modules\\mongodb\\src\\encrypter.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-var-requires */\r\nimport { deserialize, serialize } from './bson';\r\nimport { MONGO_CLIENT_EVENTS } from './constants';\r\nimport type { AutoEncrypter, AutoEncryptionOptions } from './deps';\r\nimport { MongoInvalidArgumentError, MongoMissingDependencyError } from './error';\r\nimport { MongoClient, MongoClientOptions } from './mongo_client';\r\nimport type { Callback } from './utils';\r\n\r\nlet AutoEncrypterClass: AutoEncrypter;\r\n\r\n/** @internal */\r\nconst kInternalClient = Symbol('internalClient');\r\n\r\n/** @internal */\r\nexport interface EncrypterOptions {\r\n  autoEncryption: AutoEncryptionOptions;\r\n  maxPoolSize?: number;\r\n}\r\n\r\n/** @internal */\r\nexport class Encrypter {\r\n  [kInternalClient]: MongoClient | null;\r\n  bypassAutoEncryption: boolean;\r\n  needsConnecting: boolean;\r\n  autoEncrypter: AutoEncrypter;\r\n\r\n  constructor(client: MongoClient, uri: string, options: MongoClientOptions) {\r\n    if (typeof options.autoEncryption !== 'object') {\r\n      throw new MongoInvalidArgumentError('Option \"autoEncryption\" must be specified');\r\n    }\r\n    // initialize to null, if we call getInternalClient, we may set this it is important to not overwrite those function calls.\r\n    this[kInternalClient] = null;\r\n\r\n    this.bypassAutoEncryption = !!options.autoEncryption.bypassAutoEncryption;\r\n    this.needsConnecting = false;\r\n\r\n    if (options.maxPoolSize === 0 && options.autoEncryption.keyVaultClient == null) {\r\n      options.autoEncryption.keyVaultClient = client;\r\n    } else if (options.autoEncryption.keyVaultClient == null) {\r\n      options.autoEncryption.keyVaultClient = this.getInternalClient(client, uri, options);\r\n    }\r\n\r\n    if (this.bypassAutoEncryption) {\r\n      options.autoEncryption.metadataClient = undefined;\r\n    } else if (options.maxPoolSize === 0) {\r\n      options.autoEncryption.metadataClient = client;\r\n    } else {\r\n      options.autoEncryption.metadataClient = this.getInternalClient(client, uri, options);\r\n    }\r\n\r\n    if (options.proxyHost) {\r\n      options.autoEncryption.proxyOptions = {\r\n        proxyHost: options.proxyHost,\r\n        proxyPort: options.proxyPort,\r\n        proxyUsername: options.proxyUsername,\r\n        proxyPassword: options.proxyPassword\r\n      };\r\n    }\r\n\r\n    options.autoEncryption.bson = Object.create(null);\r\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n    options.autoEncryption.bson!.serialize = serialize;\r\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n    options.autoEncryption.bson!.deserialize = deserialize;\r\n\r\n    this.autoEncrypter = new AutoEncrypterClass(client, options.autoEncryption);\r\n  }\r\n\r\n  getInternalClient(client: MongoClient, uri: string, options: MongoClientOptions): MongoClient {\r\n    // TODO(NODE-4144): Remove new variable for type narrowing\r\n    let internalClient = this[kInternalClient];\r\n    if (internalClient == null) {\r\n      const clonedOptions: MongoClientOptions = {};\r\n\r\n      for (const key of Object.keys(options)) {\r\n        if (['autoEncryption', 'minPoolSize', 'servers', 'caseTranslate', 'dbName'].includes(key))\r\n          continue;\r\n        Reflect.set(clonedOptions, key, Reflect.get(options, key));\r\n      }\r\n\r\n      clonedOptions.minPoolSize = 0;\r\n\r\n      internalClient = new MongoClient(uri, clonedOptions);\r\n      this[kInternalClient] = internalClient;\r\n\r\n      for (const eventName of MONGO_CLIENT_EVENTS) {\r\n        for (const listener of client.listeners(eventName)) {\r\n          internalClient.on(eventName, listener);\r\n        }\r\n      }\r\n\r\n      client.on('newListener', (eventName, listener) => {\r\n        internalClient?.on(eventName, listener);\r\n      });\r\n\r\n      this.needsConnecting = true;\r\n    }\r\n    return internalClient;\r\n  }\r\n\r\n  connectInternalClient(callback: Callback): void {\r\n    // TODO(NODE-4144): Remove new variable for type narrowing\r\n    const internalClient = this[kInternalClient];\r\n    if (this.needsConnecting && internalClient != null) {\r\n      this.needsConnecting = false;\r\n      return internalClient.connect(callback);\r\n    }\r\n\r\n    return callback();\r\n  }\r\n\r\n  close(client: MongoClient, force: boolean, callback: Callback): void {\r\n    this.autoEncrypter.teardown(!!force, e => {\r\n      const internalClient = this[kInternalClient];\r\n      if (internalClient != null && client !== internalClient) {\r\n        return internalClient.close(force, callback);\r\n      }\r\n      callback(e);\r\n    });\r\n  }\r\n\r\n  static checkForMongoCrypt(): void {\r\n    let mongodbClientEncryption = undefined;\r\n    try {\r\n      // Ensure you always wrap an optional require in the try block NODE-3199\r\n      mongodbClientEncryption = require('mongodb-client-encryption');\r\n    } catch (err) {\r\n      throw new MongoMissingDependencyError(\r\n        'Auto-encryption requested, but the module is not installed. ' +\r\n          'Please add `mongodb-client-encryption` as a dependency of your project'\r\n      );\r\n    }\r\n\r\n    AutoEncrypterClass = mongodbClientEncryption.extension(require('../lib/index')).AutoEncrypter;\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"script"}